<!DOCTYPE html>
<html>

<head>
    <title>Search Answers</title>
    <link rel="stylesheet" href="../../assets/styles/style.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="https://kit.fontawesome.com/dae763dd72.js" crossorigin="anonymous"></script> -->
</head>

<body>
    <header class="header"></header>
    <main id="container" class="row">
        <form id="searchForm">
            <div id="documentList"></div>

            <input type="text" id="question" placeholder="Nhập câu hỏi..." required />

            <button type="submit">Search</button>
        </form>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            <label for="file-upload" class="form-label">Select file:</label>
            <input type="file" id="file-upload" name="file" accept=".pdf" aria-describedby="file-help" />
            <div id="file-help" class="form-text">Loại tệp chấp nhận: PDF (max 10MB)</div>
            <div class="warn">Không xử lý hình ảnh trong File, nếu PDF hoàn toàn là hình ảnh, vui lòng không Upload
            </div>
            <button id="btn-upload" type="submit">Tải lên</button>
            <div id="upload-progress" class="progress" hidden>
                <div class="progress-bar" role="progressbar"></div>
            </div>
        </form>
        <div id="response">Câu trả lời nằm ở đây!</div>
    </main>
    <footer class="footer"></footer>
</body>

<script>
    // http://127.0.0.1:8000/
    // https://ragar.onrender.com
    const DOMAIN = "https://ragar.onrender.com";
    const PING_URL = `${DOMAIN}/wakeup`;
    let checkInterval = null;
    let dotCount = 0;
    const headerEl = document.querySelector(".header");

    async function wakeServer() {
        updateHeader("Đang đánh thức server");

        try {
            const res = await fetch(PING_URL, { method: "GET" });
            const data = await res.json();

            if (data?.message) {
                updateHeader(data?.message);
                return true;
            }
        } catch (err) {
            console.log("Server chưa sẵn sàng...", err);
        }

        startCheckingServer();
        return false;
    }

    function updateHeader(str) {
        headerEl.textContent = str;
    }
    wakeServer();

    async function loadDocuments() {
        const res = await fetch(`${DOMAIN}/documents/available`);
        const documents = await res.json();

        const container = document.getElementById("documentList");
        container.innerHTML = "";

        documents.forEach(doc => {
            const label = document.createElement("label");
            label.style.display = "block";

            label.innerHTML = `
      <input
        type="checkbox"
        name="documentIds"
        value="${doc._id}"
      />
      ${doc.title}
      ${doc.author ? `- ${doc.author}` : ""}
    `;

            container.appendChild(label);
        });
    }

    loadDocuments();

    const form = document.getElementById('upload-form');
    const btnUpload = document.getElementById('btn-upload');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        btnUpload.textContent = "Đợi xíu đang lưu file";
        btnUpload.disabled = true;
        const formData = new FormData(form);
        try {
            const response = await fetch(`${DOMAIN}/uploadfile`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            const result = await response.json();
            console.log('Upload successful:', result);
            alert(result.message);
        } catch (error) {
            console.error('Upload failed:', error);
            alert('Upload failed. Please try again.');
        } finally {
            btnUpload.textContent = "Tải lên";
            btnUpload.disabled = false;
            form.reset();
        }
    });

    const searchForm = document.getElementById("searchForm");
    const responseBox = document.getElementById("response");

    searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const question = document.getElementById("question").value.trim();
        if (!question) {
            alert("Vui lòng nhập nội dung tìm kiếm!");
            return;
        }

        const documentIds = Array.from(
            document.querySelectorAll('input[name="documentIds"]:checked')
        ).map(cb => cb.value);

        const payload = {
            question: question,
            document_ids: documentIds
        };

        responseBox.innerHTML = "Đang tìm kiếm...";

        try {
            const response = await fetch(`${DOMAIN}/search`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            renderChunks(data);
        } catch (error) {
            console.error(error);
            responseBox.textContent = "Lỗi khi tìm kiếm.";
        }
    });

    function renderChunks(data) {
        if (!data.chunks || data.chunks.length === 0) {
            responseBox.textContent = "Không tìm thấy kết quả phù hợp.";
            return;
        }

        let html = `<h3>Câu hỏi:</h3><p>${data.question}</p>`;
        html += `<h3>Kết quả:</h3>`;

        data.chunks.forEach((chunk, index) => {
            html += `
        <div class="chunk">
            <p><strong>#${index + 1}</strong> (Trang ${chunk.page}, Score: ${chunk.score.toFixed(3)})</p>
            <p>${chunk.text}</p>
            ${chunk.metadata
                    ? `<small>
                        ${chunk.metadata.title ?? ""}
                        ${chunk.metadata.author ? " - " + chunk.metadata.author : ""}
                      </small>`
                    : ""
                }
            <hr />
        </div>
        `;
        });

        responseBox.innerHTML = html;
    }


</script>

</html>
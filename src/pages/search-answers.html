<!DOCTYPE html>
<html>

<head>
    <title>Search Answers</title>
    <link rel="stylesheet" href="../../assets/styles/style.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header class="header"></header>

    <main id="container" class="row">

        <!-- SEARCH FORM -->
        <form id="searchForm">
            <div id="documentList"></div>

            <input type="text" id="question" placeholder="Nhập câu hỏi..." required />

            <div style="margin: 10px 0;">
                <label>
                    <input type="checkbox" id="useAI" />
                    Dùng AI để trả lời
                </label>
            </div>

            <button type="submit">Search</button>
        </form>

        <!-- UPLOAD FORM -->
        <form id="upload-form" method="post" enctype="multipart/form-data">
            <label for="file-upload">Select file:</label>
            <input type="file" id="file-upload" name="file" accept=".pdf" />
            <div class="warn">
                Không xử lý hình ảnh trong File, nếu PDF hoàn toàn là hình ảnh, vui lòng không Upload
            </div>
            <button id="btn-upload" type="submit">Tải lên</button>
        </form>

        <!-- RESPONSE -->
        <div id="response">Câu trả lời nằm ở đây!</div>
    </main>

    <footer class="footer"></footer>
</body>

<script>
    // ================= CONFIG =================
    const DOMAIN = "https://ragar.onrender.com";
    const PING_URL = `${DOMAIN}/wakeup`;

    const headerEl = document.querySelector(".header");
    const responseBox = document.getElementById("response");
    const searchForm = document.getElementById("searchForm");

    // ================= SERVER WAKE =================
    async function wakeServer() {
        headerEl.textContent = "Đang đánh thức server...";
        try {
            const res = await fetch(PING_URL);
            const data = await res.json();
            headerEl.textContent = data?.message || "Server sẵn sàng";
        } catch {
            headerEl.textContent = "Server chưa sẵn sàng...";
        }
    }
    wakeServer();

    // ================= LOAD DOCUMENTS =================
    async function loadDocuments() {
        const res = await fetch(`${DOMAIN}/documents/available`);
        const documents = await res.json();

        const container = document.getElementById("documentList");
        container.innerHTML = "<h4>Tài liệu:</h4>";

        documents.forEach(doc => {
            const label = document.createElement("label");
            label.style.display = "block";
            label.innerHTML = `
                <input type="checkbox" name="documentIds" value="${doc._id}" />
                ${doc.title} ${doc.author ? `- ${doc.author}` : ""}
            `;
            container.appendChild(label);
        });
    }
    loadDocuments();

    // ================= UPLOAD FILE =================
    const uploadForm = document.getElementById("upload-form");
    const btnUpload = document.getElementById("btn-upload");

    uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        btnUpload.disabled = true;
        btnUpload.textContent = "Đang upload...";

        const formData = new FormData(uploadForm);

        try {
            const res = await fetch(`${DOMAIN}/uploadfile`, {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            alert(data.message || "Upload thành công");
        } catch {
            alert("Upload thất bại");
        } finally {
            btnUpload.disabled = false;
            btnUpload.textContent = "Tải lên";
            uploadForm.reset();
        }
    });

    // ================= SEARCH =================
    searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const question = document.getElementById("question").value.trim();
        const useAI = document.getElementById("useAI").checked;

        const documentIds = Array.from(
            document.querySelectorAll('input[name="documentIds"]:checked')
        ).map(cb => cb.value);

        if (!question) {
            alert("Vui lòng nhập câu hỏi");
            return;
        }

        if (documentIds.length === 0) {
            alert("Vui lòng chọn ít nhất một tài liệu");
            return;
        }

        const payload = {
            question: question,
            document_ids: documentIds
        };

        responseBox.innerHTML = useAI
            ? "AI đang suy nghĩ..."
            : "Đang tìm kiếm...";

        const endpoint = useAI ? "/search/ai" : "/search";

        try {
            const res = await fetch(`${DOMAIN}${endpoint}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(res.status);

            const data = await res.json();
            useAI ? renderAIResponse(data) : renderChunks(data);

        } catch (err) {
            console.error(err);
            responseBox.textContent = "Lỗi khi tìm kiếm.";
        }
    });

    // ================= RENDER NORMAL SEARCH =================
    function renderChunks(data) {
        if (!data.chunks || data.chunks.length === 0) {
            responseBox.textContent = "Không tìm thấy kết quả.";
            return;
        }

        let html = `<h3>Câu hỏi:</h3><p>${data.question}</p><h3>Kết quả:</h3>`;

        data.chunks.forEach((c, i) => {
            html += `
                <div class="chunk">
                    <p><strong>#${i + 1}</strong> (Trang ${c.page}, Score ${c.score.toFixed(3)})</p>
                    <p>${c.text}</p>
                    <hr/>
                </div>
            `;
        });

        responseBox.innerHTML = html;
    }

    // ================= RENDER AI SEARCH =================
    function renderAIResponse(data) {
        let html = `<h3>Câu hỏi:</h3><p>${data.question}</p>`;

        if (!data.answer || !data.answer.results?.length) {
            html += `<p><em>AI không đủ dữ kiện để trả lời.</em></p>`;
        } else {
            data.answer.results.forEach(r => {
                html += `
                    <div class="ai-answer">
                        <p><strong>Trả lời:</strong> ${r.bot_answer}</p>
                        ${r.last_choice ? `<p><strong>Đáp án:</strong> ${r.last_choice}</p>` : ""}
                `;

                if (r.quote_from?.length) {
                    html += `<details><summary>Trích dẫn</summary>`;
                    r.quote_from.forEach(q => {
                        html += `
                            <p>
                                <em>${q.name_document}</em> (Trang ${q.page})<br/>
                                "${q.texts}"
                            </p>
                        `;
                    });
                    html += `</details>`;
                }

                html += `</div><hr/>`;
            });
        }

        if (data.chunks?.length) {
            html += `<h4>Ngữ cảnh sử dụng:</h4>`;
            data.chunks.forEach((c, i) => {
                html += `
                    <div class="chunk">
                        <p><strong>#${i + 1}</strong> (Trang ${c.page}, Score ${c.score.toFixed(3)})</p>
                        <p>${c.text}</p>
                    </div>
                `;
            });
        }

        responseBox.innerHTML = html;
        responseBox.scrollIntoView({ behavior: "smooth" });
    }
</script>

</html>

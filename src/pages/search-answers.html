<!DOCTYPE html>
<html>

<head>
    <title>Search Answers</title>
    <link rel="stylesheet" href="../../assets/styles/style.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="https://kit.fontawesome.com/dae763dd72.js" crossorigin="anonymous"></script> -->
</head>
<body>
    <header class="header"></header>
    <main id="container" class="row">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Nhập từ khóa cần tìm...">
            <button id="searchBtn">Search</button>
        </div>
        <form id="upload-form" method="post" enctype="multipart/form-data" action="/upload">
            <label for="file-upload" class="form-label">Select file:</label>
            <input type="file" id="file-upload" name="file" accept=".pdf" aria-describedby="file-help" />
            <div id="file-help" class="form-text">Loại tệp chấp nhận: PDF (max 10MB)</div>
            <div class="warn">Không xử lý hình ảnh trong File, nếu PDF hoàn toàn là hình ảnh, vui lòng không Upload</div>
            <button id="btn-upload" type="submit">Tải lên</button>
            <div id="upload-progress" class="progress" hidden>
                <div class="progress-bar" role="progressbar"></div>
            </div>
        </form>
        <div id="response">Câu trả lời nằm ở đây!</div>
    </main>
    <footer class="footer"></footer>
</body>

<script>
    const DOMAIN = "https://ragar.onrender.com";
    const PING_URL = `${DOMAIN}/wakeup`;
    let checkInterval = null;
    let dotCount = 0;
    const headerEl = document.querySelector(".header");

    async function wakeServer() {
        updateHeader("Đang đánh thức server");

        try {
            const res = await fetch(PING_URL, { method: "GET" });
            const data = await res.json();

            if (data?.message) {
                updateHeader(data?.message);
                return true;
            }
        } catch (err) {
            console.log("Server chưa sẵn sàng...", err);
        }

        startCheckingServer();
        return false;
    }

    function updateHeader(str) {
        headerEl.textContent = str;
    }
    wakeServer();

    const btn_search = document.getElementById("searchBtn");
    const responseBox = document.getElementById("response");
    btn_search.addEventListener("click", async () => {
        const text = document.getElementById("searchInput").value.trim();

        if (!text) {
            alert("Vui lòng nhập nội dung tìm kiếm!");
            return;
        }
        btn_search.disabled = true;
        btn_search.textContent = "Đang tìm kiếm câu trả lời...";
        const apiUrl = `${DOMAIN}/search/${text}`;
        try {
            const response = await fetch(apiUrl);
            const dataRaw = await response.json();
            // alert(dataRaw.answer);
            responseBox.textContent = dataRaw.answer;
        } catch (error) {
            alert("Lỗi khi gọi API: " + error);
        }finally{
            btn_search.disabled = false;
            btn_search.textContent = "Search";
        }
    });
    const form = document.getElementById('upload-form');
    const btnUpload = document.getElementById('btn-upload');
    form.addEventListener('submit', async (e) => {
        btnUpload.textContent = "Đợi xíu đang lưu file";
        btnUpload.disabled = true;
        e.preventDefault();
        const formData = new FormData(form);
        try {
            const response = await fetch(`${DOMAIN}/uploadfile/`, {
                method: 'POST',
                body: formData,
                signal: AbortSignal.timeout(30000), // 30-second timeout
            });

            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
            const result = await response.json();
            console.log('Upload successful:', result);
            alert(result.message);
        } catch (error) {
            console.error('Upload failed:', error);
            alert('Upload failed. Please try again.');
        } finally {
            btnUpload.textContent = "Tải lên";
            btnUpload.disabled = false;
            form.reset();
        }
    });

</script>

</html>